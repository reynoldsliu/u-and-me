<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UandMe Online Shopping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link rel="stylesheet" href="../dist/css/AttractionDetails.css">
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

</head>

<body>
    <div class="container2">
        <!-- -----Header----- -->

        <div class="Header">
            <nav class="navbar navbar-expand-lg  bg-dark navbar-dark fixed-top">

                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="../dist/img/uandmelogo-removebg-preview.png">

                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav mx-auto mb-2 mb-lg-0 ">
                            <li class="nav-item me-4">
                                <a class="nav-link" href="#">活動資訊</a>
                            </li>
                            </li>
                            <li class="nav-item me-4">
                                <a class="nav-link" href="#">行程規劃</a>
                            </li>
                            </li>
                            <li class="nav-item me-4">
                                <a class="nav-link" href="#">旅遊商城</a>
                            </li>
                            </li>
                            <li class="nav-item me-4">
                                <a class="nav-link" href="#">論壇專區</a>
                            </li>
                            </li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                    aria-expanded="false">客服專區</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#">Q&A專欄</a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item" href="#">聯絡我們</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>

                    <ul class="navbar-nav mx-auto mb-2 mb-lg-0 ">
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-search" viewBox="0 0 16 16">
                                    <path
                                        d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                                </svg>
                            </a>
                        </li>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-person" viewBox="0 0 16 16">
                                    <path
                                        d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z" />
                                </svg>
                            </a>

                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-cart2" viewBox="0 0 16 16">
                                    <path
                                        d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l1.25 5h8.22l1.25-5H3.14zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z" />
                                </svg>

                            </a>


                        </li>


                    </ul>


                </div>


            </nav>
        </div>
    </div>
    <div class="container-fluid">
        <!-- -----Bread Crumb----- -->

        <!-- <div>
            <div class="breadcontainer mb-5">
                <div class="row">
                    <nav aria-label="breadcrumb sticky">
                        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item " style="display:inline-block"><a href="#">首頁</a></li>
                                <li class="breadcrumb-item" style="display:inline-block"><a href="#">Attraction</a>
                                </li>
                                 <li class="breadcrumb-item active" aria-current="page" style="display:inline-block">Data</li> -->
        </ol>
        </nav>
        </nav>
    </div>
    </div> -->


    <!-- -----sidebar----- -->

    <div class="sidebar">

        <a href="#">景點地圖</a>
        <a href="#">景點詳情</a>



    </div>
    <div class="content-wrapper " style="
            margin-left: 260px;
        ">
        <!-- -----Content----- -->
        <!-- <div class="content"> -->
        <!-- <section class="vh-100"> -->
        <!-- <div class="container-fluid" style="height: 100%;"> -->
        <!-- <div class="row" style="height: 95%;"> -->
        <!-- The Function Adjust Position -->
        <!-- <div class="col-12 col-lg-4"> -->
        <!-- <img src="https://picsum.photos/300/200?random=10" > -->

        <!-- ================================GOOGLE API=================================== -->
        <div class="header">
            <h5>景點詳情</h5>
        </div>
        <!-- ================================列印出所有景點=================================== -->

        <div class="container " style="height: 800px; width:800px;">

            <div>

                <div class="showlist">
<!--                    <div style="display: flex; justify-content: center;">-->
<!--                        <button class="findAllAttraction my-1 mx-1 ms-2">顯示所有景點</button>-->
<!--                    </div>-->
<!--                    <div class="my-1 mx-1 ms-2">-->
<!--                        <label for="attractionName">查詢景點: </label>-->
<!--                        <input type="text" id="attractionName" placeholder="請輸入景點名稱">-->
<!--                        <div style="padding-left: 120px;">-->
<!--                            <button id="loadAttractions">查詢</button>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!--                                選擇每頁的資料顯示筆數-->
<!--                    <label for="pageSize">每頁筆數: </label>-->
<!--                    <select id="pageSize">-->
<!--                        <option value="1">1</option>-->
<!--                        <option value="5" selected>5</option>-->
<!--                        <option value="10">10</option>-->
<!--                    </select>-->
<!--                    頁碼:<input type="number" id="page" min="1" max="1" value="1">-->
<!--                    <div style=" padding-left:130px;">-->
<!--                        <input type="button" id="editAttr" value="編輯景點">-->
<!--                    </div>-->
                    <!-- ///新增bootstrap表格 -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col" style="width:100px;">景點名稱</th>
                                <th>
                                    <input type="text" id="attrName" disabled>
                                </th>
                            </tr>
                            <tr>
                                <th scope="col" style="width:100px;">景點地址</th>
                                <th>
                                    <input type="text" id="attrAddr" disabled>
                                </th>
                            </tr>
                            <tr>
                                <th scope="col" style="width:100px;">景點類型</th>
                                <th>
                                    <input type="text" id="attrTypeId" disabled>
                                </th>
                            </tr>
                            <tr>
                                <th scope="col" style="width:100px;">景點花費</th>
                                <th>
                                    <input type="text" id="attrCostRange" disabled>
                                </th>
                            </tr>
                            <tr>
                                <th scope="col" style="width:100px;">營業時間</th>
                                <th>
                                    <input type="text" id="attrBussTime" disabled>
                                </th>
                            </tr>
                            <tr>
                                <th scope="col" style="width:100px;">景點說明</th>
                                <th>
                                    <input type="text" id="attrIlla" disabled>
                                </th>
                            </tr>

                        </thead>
                        <tbody>


                        </tbody>
                    </table>
                    <div id="attrTarget"></div>
                    <div id="attrPics" style="width: 100%;">

                    </div>
                    <div id="imageGallery"></div>
                    <button id="editPictures" style="display: none;">編輯照片</button>
                    <label for="imageInput"></label>
                    <input type="file" id="imageInput" accept="image/*" multiple>
                    <div style=" padding-left:130px;">
                        <button id="submitButton">送出資料</button>
                    </div>
                    <br>
                    <div style=" padding-left:130px;">
                        <button class="edit-button" id="editButton">編輯</button>
                    </div>
                    <div style=" padding-left:130px;">
                        <button class="edit-button" id="saveButton" style="display: none;">儲存</button>
                    </div>
                    <div id="imageContainer"></div>
                    <div id="inputFile"></div>




                </div>

            </div>

            <div class="image-area">
                <img src="../dist/img/長版水水天空.jpg" alt="AttrImage" style=" width: 320px;height: 500px;overflow: hidden">
            </div>
        </div>
    </div>
    </div>


    </div>
    </div>
    </div>
    </div>

    <!-- -----Footer----- -->

    <div class=" footer">
        <div class="container-fluid footer1">
            <footer class="row row-cols-1 row-cols-sm-2 row-cols-md-5 py-5 my- border-top">
                <div class="col mb-3">
                    <a href="/" class="d-flex align-items-center mb-3 link-body-emphasis text-decoration-none">
                        <svg class="bi me-2" width="40" height="32">
                            <use xlink:href="#bootstrap" />
                        </svg>
                    </a>
                    <p class="text-body-secondary">&copy; 2023</p>
                </div>

                <div class="col mb-3">

                </div>


                <div class="col mb-3 mx-5">
                    <h5>U&Me</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">活動資訊</a></li>
                        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">行程規劃</a></li>
                        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">旅遊商城</a></li>
                        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">論壇專區</a></li>
                        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">客服專區</a></li>
                    </ul>
                </div>

                <div class="col mb-3 mx-5">
                    <h5>Follow Us</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item mb-2"><a href="#"
                                class="nav-link p-0 text-body-secondary">E-mail:u-and-me@gamil.com</a>
                        </li>
                        <li class="nav-item mb-2"><a href="#"
                                class="nav-link p-0 text-body-secondary">Tel:02-22222222</a>

                    </ul>
                    </li>

                </div>
            </footer>
        </div>
    </div>
    </div>

<!--    <script src="./js/jquery-3.7.0.min.js"></script>-->
<!--    <script src="../js/jquery-3.7.0.min.js"></script>-->
    <script src="../dist/js/jquery-3.7.0.min.js"></script>
    <!--<script src="js/selectOneAttrById.js"></script>-->

    <script>
        const baseUrl = window.location.protocol + "//" + window.location.host + "/u-and-me/";//+ window.location.pathname;
        const imageInput = document.getElementById('imageInput');

        //景點圖片顯示的位置標籤
        const imageGallery = document.getElementById("imageGallery");
        //新增圖片預覽 且透過createImageContainer產生容器及刪除物件
        imageInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            const urlParams = new URLSearchParams(window.location.search);
            const attrId = urlParams.get("attrId");


            // 获取当前页面的 URL
            const currentURL = window.location.href;
            // 创建一个 URLSearchParams 对象，传入查询参数部分
            const urlSearchParams = new URLSearchParams(currentURL.split('?')[1]);
            // 使用 get() 方法来获取特定查询参数的值
            console.log(files.length);
            for (const file of files) {
                let count = 0;
                var fileReader = await new FileReader();
                fileReader.onload = async event => {
                    const base64String = btoa(event.target.result);
                    const imgdata = {
                        attrPicId: 0,
                        attrId: attrId,
                        attrPicData: base64String
                    }

                    const imageContainer = createImageContainer_preview(imgdata);
                    imageGallery.appendChild(imageContainer);
                };
                console.log(++count);
                await fileReader.readAsBinaryString(file);
            }



        });

        function createImageContainer_preview(pic) {
            console.log("Creating preview");
            const imageContainer = document.createElement("div");
            imageContainer.classList.add("image-container");
            const image = document.createElement("img");
            image.src = "data: image/jpg;base64," + pic.attrPicData;
            const attrPicId = pic.attrPicId;
            imageContainer.setAttribute("attrPicId", attrPicId);
            const attrId = pic.attrId;
            imageContainer.setAttribute("attrId", attrId);

            const closeButton = document.createElement("span");
            closeButton.classList.add("close-button");
            closeButton.innerHTML = "×";

            closeButton.addEventListener("click", async function () {
                const attrPicId = imageContainer.getAttribute("attrPicId");
                console.log("deleting attrPicId:" + attrPicId);
                const delResponse = await fetch(baseUrl + 'delAttrPic/' + attrPicId);
                imageContainer.remove();
                imageInput.value = '';
            });
            console.log("attrId:" + attrId + ", attrPicId:" + attrPicId + ", attrPicData" + image.src);
            imageContainer.appendChild(image);
            imageContainer.appendChild(closeButton);

            return imageContainer;
        }

        //產生一個圖片及其容器，右上角有可觸發的紅色叉叉
        function createImageContainer(imageSrc) {
            console.log(imageSrc);
            const imageContainer = document.createElement("div");
            imageContainer.classList.add("image-container");

            const image = document.createElement("img");
            image.src = "data: image/jpeg;base64," + imageSrc.attrPicData;
            const attrPicId = imageSrc.attrPicId;
            imageContainer.setAttribute("attrPicId", attrPicId);
            const attrId = imageSrc.attrId;
            imageContainer.setAttribute("attrId", attrId);

            const closeButton = document.createElement("span");
            closeButton.classList.add("close-button");
            closeButton.innerHTML = "×";

            closeButton.addEventListener("click", async function () {
                const attrPicId = imageContainer.getAttribute("attrPicId");
                console.log("deleting attrPicId:" + attrPicId);
                const delResponse = await fetch(baseUrl + 'delAttrPic/' + attrPicId);
                imageContainer.remove();
            });

            imageContainer.appendChild(image);
            imageContainer.appendChild(closeButton);

            return imageContainer;
        }


        const attrName = document.querySelector("#attrName");
        const attrAddr = document.querySelector("#attrAddr");
        const attrTypeId = document.querySelector("#attrTypeId");
        const attrCostRange = document.querySelector("#attrCostRange");
        const attrBussTime = document.querySelector("#attrBussTime");
        const attrIlla = document.querySelector("#attrIlla");

        const urlParams = new URLSearchParams(window.location.search);
        const attrId = urlParams.get("attrId");

        $(document).ready(async function () {

            const response1 = await fetch(baseUrl+'getAttr' + '?attrId=' + attrId);
            const attr = await response1.json();
            const response2 = await fetch(baseUrl+'getAttrPics' + '/' + attrId);
            const attrPics = await response2.json();
            const picsArray = attrPics.attrPic;

            const attrPics_el = document.querySelector(".attrPics");
            let count = 0;
            // for (let pic of picsArray) {
            //     const div = document.createElement("div");
            //     div.id = "img" + ++count;
            //     div.style = "display:inline-block;";
            //     const row = document.createElement("img");
            //     row.src = "data: image/jpeg;base64," + pic.attrPicData;

            //     document.getElementById("attrPics").insertAdjacentElement('beforeend', div);
            //     document.getElementById("img" + count).insertAdjacentElement('afterbegin', row);
            // }
            //透過函數為每一個圖片生成容器及img物件
            for (let pic of picsArray) {
                const imageContainer = createImageContainer(pic);
                imageGallery.appendChild(imageContainer);
            }
            // let delResponse;
            // if (picsArray.length > 0)
            //     delResponse = await fetch(baseUrl + 'deleteAttrPictures/' + attrId);



            // const row = document.createElement("tr");
            // attr_id, attr_veri_sta, attr_sta, attr_name, attr_addr,
            // attr_lon, attr_lat, attr_illa, attr_type_id, attr_buss_time, attr_cost_range, attr_rep
            // 1	1	1	Attraction 1	123 Main St	12.345	67.89
            // Description for Attraction 1	1	9:00 AM - 5:00 PM	2	Representative for Attraction 1
            attrName.value = `${attr.attrName}`;
            attrAddr.value = `${attr.attrAddr}`;
            attrTypeId.value = `${attr.attrTypeId}`;
            attrCostRange.value = `${attr.attrCostRange}`;
            attrBussTime.value = `${attr.attrBussTime}`;
            attrIlla.value = `${attr.attrIlla}`;

        })

        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        const insertMultiPictures = async function () {
            //將特定範圍內的圖片逐次送入資料庫
            const imgElements = imageGallery.querySelectorAll("img");

            const imgSrcArray = [];
            imgElements.forEach(imgElement => {
                imgSrcArray.push(imgElement.src);
            });
            const files = imageInput.files;

            console.log("開始上傳圖片");
            for (const file of files) {
                try {
                    const fileReader = await new FileReader();
                    // 获取当前页面的 URL
                    const currentURL = window.location.href;
                    // 创建一个 URLSearchParams 对象，传入查询参数部分
                    const urlSearchParams = new URLSearchParams(currentURL.split('?')[1]);
                    // 使用 get() 方法来获取特定查询参数的值
                    const attrId = urlSearchParams.get('attrId');
                    fileReader.onload = async event => {
                        const base64Str = btoa(event.target.result);
                        const response = await fetch(baseUrl + 'insertAttrPictures/' + attrId, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                attrId: attrId,
                                attrPicData: base64Str
                            })
                        });

                    };
                    // const base64String = "your-base64-string-here";
                    // const contentType = "image/jpeg"; // 替换为实际的内容类型
                    // const base64String = file.replace(/^data:image\/(png|jpg|jpeg);base64,/, '');
                    // const blob = dataURItoBlob(file);
                    // const blob = base64ToBlob(base64String, contentType);
                    fileReader.readAsBinaryString(file);

                    // if (response.ok) {
                    //     console.log('Image uploaded successfully');
                    // } else {
                    //     console.error('Image upload failed');
                    // }
                } catch (error) {
                    console.error('Error uploading image:', error);
                }
            }
            console.log("上傳圖片結束");
        };


        const attrName_input = document.getElementById("attrName");
        const attrAddr_input = document.getElementById("attrAddr");
        const attrTypeId_input = document.getElementById("attrTypeId");
        const attrCostRange_input = document.getElementById("attrCostRange");
        const attrBussTime_input = document.getElementById("attrBussTime");
        const attrIlla_input = document.getElementById("attrIlla");

        const editPicturesButton = document.getElementById("editPictures");
        const editButton = document.getElementById("editButton");
        const saveButton = document.getElementById("saveButton");
        const submitButton = document.getElementById("submitButton");

        // Edit button click event listener
        editButton.addEventListener("click", function () {
            enableEditing();
        });

        // Save button click event listener
        saveButton.addEventListener("click", function () {
            disableEditing();
        });

        editPicturesButton.addEventListener("click", function () {


        });


        // Add button click event listener
        submitButton.addEventListener("click", async function () {
            const newData = {
                attrName: attrName_input.value,
                attrAddr: attrAddr_input.value,
                attrTypeId: attrTypeId_input.value,
                attrCostRange: attrCostRange_input.value,
                attrBussTime: attrBussTime_input.value,
                attrIlla: attrIlla_input.value
            };

            // Send data to backend using fetch
            const response = await fetch(baseUrl + 'updateAttr/' + attrId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newData)
            });

            if (response.ok) {
                // Handle successful response
                console.log('Data added successfully');
            } else {
                // Handle error response
                console.error('Error adding data');
            }

            //上傳所有在imageGallery的照片
            insertMultiPictures();
        });

        // Function to enable editing
        function enableEditing() {
            attrName_input.disabled = false;
            attrAddr_input.disabled = false;
            attrTypeId_input.disabled = false;
            attrCostRange_input.disabled = false;
            attrBussTime_input.disabled = false;
            attrIlla_input.disabled = false;

            editPicturesButton.style.display = "block";
            editButton.style.display = "none";
            saveButton.style.display = "block";
        }


        // Function to disable editing
        function disableEditing() {
            attrName_input.disabled = true;
            attrAddr_input.disabled = true;
            attrTypeId_input.disabled = true;
            attrCostRange_input.disabled = true;
            attrBussTime_input.disabled = true;
            attrIlla_input.disabled = true;

            editPicturesButton.style.display = "none";
            editButton.style.display = "block";
            saveButton.style.display = "none";
        }
    </script>

</body>

</html>