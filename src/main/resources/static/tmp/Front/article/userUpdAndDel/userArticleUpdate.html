<!doctype html>
<html lang="en">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.6/dist/sweetalert2.min.css">

<!-- SweetAlert2 JavaScript -->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>編輯文章</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/sidebars/">

    <!-- sweetalert2-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">


    <!-- Bootstrap core CSS -->
    <!-- <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet"> -->

    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }


        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }
    </style>


    <!-- Custom styles for this template -->
    <link href="userArticleUpdate.css" rel="stylesheet">

</head>

<body>


    <main>



        <div class="d-flex flex-column flex-shrink-0 p-3"
            style=" width: 100%;min-height: 100vh;background-color:#47535a;">

            <div class="shadow p-5 my-3 bg-body rounded " style="min-height:70vh;width:80vw;margin-left:10vw;">
                <!-- 以上是公版-->
                <h4 style="text-align: center">編輯文章</h4>
                <!-- 內容從這開始-->
                <form>
                    <div class="row">
                        <div class="col-9">

                            <div class="mb-3">
                                <label for="acTypeId">發文看版</label>
                                <input id="acTypeId" name="acTypeId" type="text" class="form-control">
                            </div>

                            <div class="mb-3">
                                <label for="articleTitle">文章標題</label>
                                <input id="articleTitle" name="articleTitle" type="text" class="form-control">
                            </div>
                            <div class="mb-3 mt-4">
                                <label for="articleContent" class="form-label">文章內容</label>
                                <!-- 給要被傳送到後端的標籤id值 -->
                                <textarea id="articleContent" name="articleContent" rows="10" type="text"
                                    class="form-control"></textarea>
                            </div>

                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="articlePic">圖片</label>
                                <div class="imgOuterFrame" id="imgOuterFrame">

                                    <!--動態插入圖片
                                            <div class="imgInnerFrame" id="imgInnerFrame">
                                             <img id="articlePic" src="" alt="Loading..."
                                        style="max-width: 100%; max-height: 100%;"> 
                                         </div>
                                    -->

                                </div>
                            </div>




                        </div>

                    </div>
                </form>
                <form id="picForm">
                    <div class="mb-2 mt-5">
                        <p>上傳照片</p>

                        <div id="fileInputs" style="margin-bottom: 20px;">
                            <!-- 動態生成上傳欄位 -->
                        </div>
                        <button type="button" id="addFileButton" class="btn btn-secondary"
                            style="margin-bottom: 40px;">新增圖片</button>
                    </div>
                    <!-- <button type="submit" class="btn btn-primary-send">發表</button> -->
                </form>
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <button type="submit" id="submit" class="btn btn-success">確認修改
                        </button>
                    </div>
                </div>


            </div>
        </div>


        <!--JS--> <!--JS--> <!--JS--> <!--JS--> <!--JS--> <!--JS--> <!--JS--> <!--JS--> <!--JS-->
        <script>

            // 取得查詢articleId值
            const urlParams = new URLSearchParams(window.location.search);
            const memId = urlParams.get('memId');
            const articleId = urlParams.get('articleId');

            // 表單中的各輸入框元素
            const acTypeId_el = document.getElementById('acTypeId');
            const imgOuterFrame_el = document.getElementById('imgOuterFrame');
            // const articlePicImage = document.getElementById('articlePic');
            const articleTitle_el = document.getElementById('articleTitle');
            const articleContent_el = document.getElementById('articleContent');
            const submitBtn = document.getElementById('submit');
            let cover;

            // 使用 fetch API 發送請求，獲取單筆活動詳細資料
            async function fetchArticleDetail() {
                try {
                    const response = await fetch(`http://localhost:8081/u-and-me/UserEdit/${memId}/${articleId}`);
                    const articleDetail = await response.json();
                    console.log(articleDetail);

                    // 將文章詳細資訊填充到輸入框中
                    acTypeId.value = articleDetail.acTypeId;
                    articleTitle_el.value = articleDetail.articleTitle;
                    articleContent_el.value = articleDetail.articleContent;

                } catch (error) {
                    console.error('Error fetching article detail:', error);
                }
            }

            async function fetchArticlePic() {

                try {
                    const response = await fetch(`http://localhost:8081/u-and-me/article_comment/articleId/article_pic/${articleId}`);
                    const articlePicsArray = await response.json();
                    console.log(articlePicsArray);


                    // 遍歷圖片並創建img元素顯示
                    articlePicsArray.forEach(pic => {
                        // 創建包装圖片的<img>
                        const imgInnerFrame_el = document.createElement('div');
                        imgInnerFrame_el.classList.add('imgInnerFrame');

                        const img_el = document.createElement('img');
                        img_el.src = `data:image/png;base64,${pic.articlePic}`; // 使用Base64編碼的圖片
                        img_el.alt = "Loading...";
                        img_el.classList.add('img_el'); // 根據需要添加樣式
                        img_el.id = `${pic.articlePicId}`;

                        const deleteButton_el = document.createElement('button');
                        deleteButton_el.classList.add('deleteButton');
                        deleteButton_el.addEventListener('click', () => {
                            confirmDelete(`${pic.articlePicId}`);
                            console.log("level1");
                        })
                        deleteButton_el.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"></path>
                                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"></path>
                            </svg>
                        `;

                        //游標滑到圖片上方時，會出現刪除圖示，且圖示綁定onclick事件
                        imgInnerFrame_el.addEventListener('mouseenter', () => {
                            // 顯示刪除圖示
                            imgInnerFrame_el.appendChild(deleteButton_el);
                        });

                        imgInnerFrame_el.addEventListener('mouseleave', () => {
                            // 隐藏刪除圖示
                            imgInnerFrame_el.removeChild(deleteButton_el);
                        });


                        imgOuterFrame_el.appendChild(imgInnerFrame_el);
                        imgInnerFrame_el.appendChild(img_el);

                    });
                } catch (error) {
                    console.error('Error fetching article detail:', error);
                }
            }

            function confirmDelete(articlePicId) {
                // 在點擊刪除的圖示後，不會自動送出網內容
                event.preventDefault();
                swal.fire({
                    title: '刪除後即無法回復圖片，確定繼續刪除動作?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '確定',
                    cancelButtonText: '取消'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        // 點擊確認按鈕後在此執行删除操作
                        await fetch(`http://localhost:8081/u-and-me/UserEdit/upd/deletePic/${articlePicId}`, {
                            method: 'DELETE'
                        });
                        console.log(`圖片 ${articlePicId} 已成功删除`);
                        location.reload();
                    } else {
                        console.error("用户点击了取消按钮，不执行删除操作");
                    }
                });

            }
            const fileInputsContainer = document.getElementById('fileInputs');
            const addFileButton_el = document.getElementById('addFileButton');

            addFileButton_el.addEventListener('click', function () {
                // 包著預覽圖與上傳欄位的div
                const imagePreviewContainer = document.createElement('div');
                // 上傳欄位
                const newFileInput = document.createElement('input');
                // 預覽圖
                const imagePreview = document.createElement('img');

                newFileInput.type = 'file';
                newFileInput.name = 'files';
                newFileInput.className = 'form-control_';
                // event参数包含了关于事件的信息，包括用户选择的文件。
                newFileInput.addEventListener('change', function (event) {
                    // event.target表示触发事件的元素(也就是新增的檔案)，而files属性是一个包含用户选择文件的文件列表。
                    // 因为選擇檔案時可一次選多個，使用[0]來解析選擇圖片中的第一個。
                    const file = event.target.files[0];
                    // 檢查file是否確實有被選中檔案，而不是取消上傳等其他動作
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            imagePreview.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        // 将文件内容读取为数据 URL（以data:开头的 URL）。这个 URL 包含了文件的二进制数据，可以直接用于图像预览。
                    }
                });

                fileInputsContainer.appendChild(imagePreviewContainer);
                imagePreviewContainer.appendChild(newFileInput);
                imagePreviewContainer.appendChild(imagePreview);
            });
            //格式化日期
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('zh-TW', options);
            }

            //在網頁載入完成後執行
            document.addEventListener('DOMContentLoaded', function () {
                fetchArticleDetail();
                fetchArticlePic();

                // 選擇圖片時觸發事件
                const cover_el = document.getElementById('inputGroupFile04');
                // const cover_img = document.getElementById('articlePic');


                // cover_el.addEventListener('change', function () {
                //     const file = this.files[0];
                //     if (file) {
                //         cover_img.src = URL.createObjectURL(file);

                //         const fileReader = new FileReader();
                //         fileReader.onload = event => {
                //             cover = btoa(event.target.result);
                //         };
                //         fileReader.readAsBinaryString(file);
                //     } else {
                //         cover_img.src = "";

                //     }
                // });
            });


            // 在提交審核按鈕被點擊時執行以下程式碼
            submitBtn.addEventListener('click', async function (event) {

                event.preventDefault()

                // 構建要傳遞的資料
                const requestData = {
                    acTypeId: acTypeId_el.value,
                    articleTitle: articleTitle_el.value,
                    articleContent: articleContent_el.value,
                    articleId: articleId,
                };

                // if檢查cover是否有值，如果有選擇圖片，則更新articlePic
                // if (cover) {
                //     requestData.articlePic = cover;
                // }

                try {
                    // 使用FormData型態處理form(picForm)裡面的檔案

                    const formData = new FormData(picForm);
                    const post_picURL = `http://localhost:8081/u-and-me/UserEdit/upd/post_pics/${articleId}`;
                    fetch(post_picURL, {
                        method: "POST",
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });

                    const response = await fetch(`http://localhost:8081/u-and-me/UserEdit/upd/${memId}/${articleId}`, {

                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })

                        .then(response => {
                            console.log(response)
                            if (response.ok) {
                                console.log('狀態更新成功。');
                                Swal.fire({
                                    icon: 'success',
                                    title: '文章更新成功',
                                    text: '',
                                    confirmButtonText: '確定'
                                }).then((result) => {
                                    // if (result.isConfirmed) { ... }：这是一个条件语句，检查用户是否点击了 
                                    // SweetAlert2 弹出框中的 "確定" 按钮。如果用户点击了 "確定" 按钮，那么条件成立，将执行括号内的代码块。
                                    if (result.isConfirmed) {
                                        window.location.href = `http://localhost:8081/u-and-me/tmp/Front/article/userUpdAndDel/userArticleFindById.html?memId=${memId}`
                                    }

                                });

                            } else {
                                console.error('無法更新狀態。');

                            }
                        })

                } catch (error) {
                    console.error('Error to update article.', error);
                }
            });

        </script>


    </main>


    <script src="assets/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.6/dist/sweetalert2.min.js"></script>

    <!--<script src="activityEdit.js"></script>-->

</body>

</html>